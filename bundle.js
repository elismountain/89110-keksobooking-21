(()=>{"use strict";window.util={debounce:e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}},numDecline:(e,t,o,r)=>{if(e>10&&1===Math.round(e%100/10))return r;switch(e%10){case 1:return t;case 2:case 3:case 4:return o;default:return r}},ENTER_KEYCODE:13,ESC_KEYCODE:27},(()=>{const e="https://21.javascript.pages.academy/keksobooking/data",t="https://21.javascript.pages.academy/keksobooking",o="GET",r="POST",n=document.querySelector("#error").content.querySelector(".error"),i=e=>{const t=n.cloneNode(!0);t.querySelector(".error__message").textContent=e,document.querySelector("main").appendChild(t),document.addEventListener("keydown",(e=>{e.keyCode!==window.util.ESC_KEYCODE&&e.keyCode!==window.util.ENTER_KEYCODE||(window.map.onResetMode(),t.parentNode.removeChild(t))})),t.addEventListener("click",(()=>{window.map.onResetMode(),window.form.addForm.reset(),window.card.hideActiveCard(),t.parentNode.removeChild(t)}))},d=(e,t,r,n)=>{const d=new XMLHttpRequest;d.responseType="json",d.addEventListener("load",(()=>{200===d.status?r(d.response):i(`При обращению к серверу произошла ошибка. Статус ответа: ${d.status} ${d.statusText}. Попробуйте перезагрузить страницу`)})),d.addEventListener("error",(()=>{i(`Произошла ошибка соединения. Статус ответа: ${d.status} ${d.statusText}. Попробуйте перезагрузить страницу`)})),d.addEventListener("timeout",(()=>{i(`Запрос не успел выполниться за ${d.timeout}мс. Статус ответа: ${d.status} ${d.statusText}. Попробуйте перезагрузить страницу`)})),d.open(e,t),d.timeout=1e4,d.send(e===o?"":n)};window.load={load:t=>{d(o,e,t)},upload:(e,o)=>{d(r,t,o,e)},showError:i}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".ad-form__reset"),o="1000",r=()=>{e.classList.add("map--faded"),window.form.addForm.classList.add("ad-form--disabled"),window.form.toggleDisabledOnForm(),window.form.addForm.reset(),window.images.resetImage(),window.card.hideActiveCard(),window.pin.removePins(),window.form.addForm.price.placeholder=o,window.form.addForm.price.min=o,(()=>{const t=e.offsetHeight/2,o=(e.offsetWidth-window.pin.mapPinMain.offsetWidth)/2;window.pin.mapPinMain.style.top=t+"px",window.pin.mapPinMain.style.left=o+"px"})(),window.form.fillForm()};t.addEventListener("click",r),window.map={onActiveMode:()=>{e.classList.remove("map--faded"),window.form.addForm.classList.remove("ad-form--disabled"),window.filter.updateSimillarPins(window.data.listOfRentals),window.form.toggleDisabledOnForm();const t=window.util.debounce((()=>{window.filter.updateSimillarPins(window.data.listOfRentals)}));window.form.formFiltersNode.addEventListener("change",t)},mainMap:e,onResetMode:r}})(),window.data={listOfRentals:[]},(()=>{const e=window.map.mainMap.querySelector(".map__pins"),t=document.querySelector("#pin").content,o=window.map.mainMap.querySelector(".map__pin--main"),r=e=>{window.data.listOfRentals=e,window.map.onActiveMode()};o.addEventListener("mousedown",(e=>{e.preventDefault();let t={x:e.clientX,y:e.clientY};const r=e=>{e.preventDefault();const r=t.x-e.clientX,n=t.y-e.clientY;t={x:e.clientX,y:e.clientY};let i=o.offsetTop-n,d=o.offsetLeft-r;const a=110-o.offsetHeight,s=610-o.offsetHeight;i<a?i=a:i>s&&(i=s);const l=-o.offsetWidth/2,c=window.map.mainMap.offsetWidth-o.offsetWidth/2;d<l?d=l:d>c&&(d=c),o.style.top=i+"px",o.style.left=d+"px",window.form.fillForm()},n=e=>{e.preventDefault(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",n)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",n)})),window.pin={getPinCoords:()=>{let e=0,t=0;return window.form.addForm.classList.contains("ad-form--disabled")?(e=Math.round(o.offsetLeft+o.offsetWidth/2),t=Math.round(o.offsetTop+o.offsetHeight/2)):(e=Math.round(o.offsetLeft+o.offsetWidth/2),t=Math.round(o.offsetTop+20+o.offsetHeight),t<130?t=130:t>630&&(t=630)),String(e)+", "+String(t)},mapListElement:e,getMapPin:o=>{let r=t.querySelector(".map__pin").cloneNode(!0);const n=r.querySelector("img");return r.style.left=o.location.x-n.width/2+"px",r.style.top=o.location.y-n.height+"px",r.querySelector("img").setAttribute("src",o.author.avatar),r.addEventListener("click",(()=>{window.card.show(o),e.appendChild(window.card.mapCard)})),r},initMapPinMain:()=>{o.addEventListener("mousedown",(e=>{0===e.button&&window.load.load(r)})),o.addEventListener("mouseup",(e=>{0===e.button&&window.form.fillForm()})),o.addEventListener("keydown",(e=>{e.keyCode===window.util.ENTER_KEYCODE&&(window.load.load(r),window.form.fillForm())}))},removePins:()=>{const t=e.querySelectorAll(".map__pin:not(.map__pin--main)");for(let e of t)e.parentNode.removeChild(e)},createPins:e=>{const t=document.createDocumentFragment();for(let o=0;o<e.length;o++){const r=window.pin.getMapPin(e[o]);t.appendChild(r)}window.pin.mapListElement.appendChild(t)},mapPinMain:o}})(),(()=>{const e=["wifi","dishwasher","parking","washer","elevator","conditioner"],t={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},o=(o,r)=>{(()=>{for(let t=0;t<e.length;t++){const n=r.querySelectorAll(".popup__feature--"+e[t])[0];o.offer.features.includes(e[t])?n.classList.remove("hidden"):n.classList.add("hidden")}})();const n=r.querySelector(".popup__photos");for(;n.firstChild;)n.removeChild(n.firstChild);n.appendChild((e=>{const t=document.createDocumentFragment();return e.forEach((e=>{const o=document.createElement("img");o.className="popup__photo",o.width=45,o.height=40,o.alt="Фотография жилья",o.src=e,t.appendChild(o)})),t})(o.offer.photos)),r.querySelector(".popup__title").textContent=o.offer.title,r.querySelector(".popup__text--address").textContent=o.offer.address,r.querySelector(".popup__text--price").textContent=o.offer.price+"₽/ночь",r.querySelector(".popup__type").textContent=t[o.offer.type],r.querySelector(".popup__text--capacity").textContent=o.offer.rooms+window.util.numDecline(o.offer.rooms," комната"," комнаты"," комнат")+" для "+o.offer.guests+window.util.numDecline(o.offer.guests," гостя"," гостей"," гостей"),r.querySelector(".popup__text--time").textContent="Заезд после "+o.offer.checkin+", выезд до "+o.offer.checkout,r.querySelector(".popup__description").textContent=o.offer.description,r.querySelector(".popup__avatar").setAttribute("src",o.author.avatar)},r=()=>{const e=document.querySelector("#card").content.querySelector(".map__card").cloneNode(!0);e.querySelector(".popup__close").addEventListener("click",(()=>{i()}));const t=document.querySelector(".map__filters-container");return t.parentNode.insertBefore(e,t),e},n=r();n.classList.add("hidden");const i=()=>{n.classList.add("hidden")};window.card={createCard:r,fillCard:o,mapCard:n,show:e=>{n.classList.remove("hidden"),o(e,n);const t=e=>{e.keyCode===window.util.ESC_KEYCODE&&i(),window.map.mainMap.removeEventListener("keydown",t)};window.map.mainMap.addEventListener("keydown",t)},hideActiveCard:i}})(),(()=>{const e=window.map.mainMap.querySelector(".map__filters-container"),t=e.querySelector(".map__filters"),o=document.querySelector(".ad-form"),r=window.card.mapCard.querySelector(".popup__text--address"),n=o.querySelector("#address"),i=o.querySelector("#capacity"),d=o.querySelector("#room_number"),a=o.querySelectorAll("#price"),s=document.querySelector("main"),l=document.querySelector("#success").content.querySelector(".success"),c=o.querySelector("#title"),m={palace:1e4,house:5e3,flat:1e3,bungalow:0},u={1:[0,2,3],2:[0,3],3:[0],100:[1,2,3]},p=()=>{window.map.onResetMode(),(()=>{const e=l.cloneNode(!0);s.appendChild(e),e.addEventListener("click",(()=>{e.parentNode.removeChild(e)})),document.addEventListener("keydown",(t=>{t.preventDefault(),t.keyCode!==window.util.ESC_KEYCODE&&t.keyCode!==window.util.ENTER_KEYCODE||e.parentNode.removeChild(e)}),{once:!0})})()};o.addEventListener("submit",(e=>{window.load.upload(new FormData(o),p),e.preventDefault()}));const w=()=>{const e=o.classList.contains("ad-form--disabled"),r=t=>{t.disabled=e,t.classList.toggle("disable-cursor")};Array.from(o.children).forEach(r),Array.from(t.children).forEach(r)},f=()=>{let e=parseInt(d.value,10);var t;i.querySelector('option[value="'+String(e%100)+'"]').selected=!0,t=u[d.value],i.querySelectorAll("option").forEach((e=>{e.disabled=t.includes(parseInt(e.value,10))}))};d.addEventListener("change",f),o.addEventListener("change",(e=>{switch(e.target){case o.timein:case o.timeout:h(e);break;case o.type:o.price.min=m[o.type.value],o.price.placeholder=m[o.type.value]}}));const h=e=>{e.target===o.timein?o.timeout.value=o.timein.value:o.timein.value=o.timeout.value};window.form={addForm:o,formAddress:n,fillForm:()=>{n.value=window.pin.getPinCoords()},roomSelect:d,initForm:()=>{c.required=!0,c.minLength=30,c.maxLength=100,r.required="required",r.addEventListener("keydown",(e=>{e.keyCode!==window.util.ENTER_KEYCODE&&e.preventDefault()})),n.value=window.pin.getPinCoords(),w(),a.required=!0,a.value=1e3,a.min=0,a.max=1e6,f()},toggleDisabledOnForm:w,mapFiltersNode:e,formFiltersNode:t}})(),(()=>{const e=Array.from(window.form.formFiltersNode.features),t=(e,t,o,r)=>"any"===window.form.formFiltersNode[e].value||parseInt(r.offer[t],10)===parseInt(window.form.formFiltersNode[e].value,10),o=e=>"any"===window.form.formFiltersNode["housing-type"].value||e.offer.type===window.form.formFiltersNode["housing-type"].value,r=(e,o,r)=>t("housing-rooms","rooms",0,e),n=(e,o,r)=>t("housing-guests","guests",0,e),i=e=>{switch(window.form.formFiltersNode["housing-price"].value){case"low":return e.offer.price<1e4;case"middle":return e.offer.price>=1e4&&e.offer.price<=5e4;case"high":return e.offer.price>5e4;default:return!0}},d=t=>!e.some((e=>e.checked&&!t.offer.features.includes(e.value)));window.filter={updateSimillarPins:e=>{const t=e.filter(o).filter(r).filter(n).filter(i).filter(d).slice(0,5);window.card.hideActiveCard(),window.pin.removePins(),window.pin.createPins(t)}}})(),window.pin.initMapPinMain(),window.form.initForm(),(()=>{const e=["gif","jpg","jpeg","png"],t=window.form.addForm.querySelector(".ad-form-header__input"),o=window.form.addForm.querySelector(".ad-form__input"),r=window.form.addForm.querySelector(".ad-form-header__preview img"),n=window.form.addForm.querySelector(".ad-form__photo img"),i={AVATAR:r.src,ROOM:""},d=(t,o)=>{const r=t.files[0],n=r.name.toLowerCase();if(e.some((e=>n.endsWith(e)))){let e=new FileReader;e.addEventListener("load",(()=>{o.classList.remove("hidden"),o.src=e.result})),e.readAsDataURL(r)}};t.addEventListener("change",(()=>{d(t,r)})),o.addEventListener("change",(()=>{d(o,n)})),window.images={resetImage:()=>{n.classList.add("hidden"),n.src=i.ROOM,r.src=i.AVATAR}}})()})();